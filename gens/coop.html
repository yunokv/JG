<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>COOP Barcode Generator</title>
<style>
  body {font-family: Arial, sans-serif;background: #111;color: #fff;display: flex;justify-content: center;align-items: center;height: 100vh;margin: 0;}
  .card {background: #1c1c1c;padding: 2rem;border-radius: 12px;width: 420px;text-align: center;box-shadow: 0 0 15px rgba(255,255,255,0.06);}
  h1 {font-size: 1.5rem;margin-bottom: 14px;color: #2196f3;}
  input[type=text], input[type=number] {width: 100%;padding: 10px;margin: 6px 0;font-size: 15px;border: none;border-radius: 8px;outline: none;background: #222;color: #fff;}
  input[type=text]:focus, input[type=number]:focus {border: 2px solid #2196f3;}
  button {padding: 10px 16px;font-size: 15px;border-radius: 8px;border: none;background: #2196f3;font-weight: bold;color: #081018;cursor: pointer;transition: all 0.15s ease;}
  button.secondary {background:#444;color:#fff}
  button:hover {transform: translateY(-2px)}
  .row {display:flex;gap:8px;justify-content:center;margin-top:12px}
  #result {margin-top:16px;display:none}
  svg {background:#fff;border-radius:6px;display:block;margin:auto}
  .error {color:#f44336;font-weight:bold;margin-top:10px}
</style>
</head>
<body>
  <div class="card">
    <h1>COOP Barcode Generator</h1>
    <input id="barcode" type="text" inputmode="numeric" placeholder="Barcode digits (EAN-13)">
    <input id="price" type="number" min="1" max="99" placeholder="Price (pence)">
    <input id="name" type="text" placeholder="Product name (optional)">
    <div class="row">
      <button id="generate">Generate</button>
      <button id="download" class="secondary">Download PNG</button>
    </div>
    <div id="result">
      <svg id="barcodeSvg" width="340" height="100"></svg>
    </div>
    <div id="error" class="error"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script>
    const barcodeInput = document.getElementById('barcode');
    const priceInput = document.getElementById('price');
    const nameInput = document.getElementById('name');
    const generateBtn = document.getElementById('generate');
    const downloadBtn = document.getElementById('download');
    const barcodeSvg = document.getElementById('barcodeSvg');
    const resultBox = document.getElementById('result');
    const errorBox = document.getElementById('error');

    function calcCheckDigit(base12) {
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        const n = parseInt(base12[i], 10);
        if (isNaN(n)) return null;
        sum += (i % 2 === 0) ? n : n * 3;
      }
      const mod = sum % 10;
      return mod === 0 ? 0 : 10 - mod;
    }

    function normalizeToEAN13(raw) {
      let cleaned = (raw || '').replace(/\D/g, '');
      if (!cleaned.length) return null;
      if (cleaned.length > 13) cleaned = cleaned.slice(-13);
      if (cleaned.length < 13) cleaned = cleaned.padStart(13, '0');
      const base12 = cleaned.slice(0, 12);
      const check = calcCheckDigit(base12);
      if (check === null) return null;
      return base12 + String(check);
    }

    generateBtn.addEventListener('click', () => {
      errorBox.textContent = '';
      const raw = barcodeInput.value.trim();
      const price = priceInput.value.trim();
      const name = nameInput.value.trim();
      if (!raw) { errorBox.textContent = 'Enter barcode digits'; return; }

      const ean13 = normalizeToEAN13(raw);
      if (!ean13) { errorBox.textContent = 'Invalid digits'; return; }

      try {
        JsBarcode('#barcodeSvg', ean13, {
          format: 'ean13',
          displayValue: false,
          height: 70,
          margin: 0,
          lineColor: '#000'
        });
      } catch {
        errorBox.textContent = 'Failed to render barcode';
        return;
      }

      resultBox.style.display = 'block';
    });

    downloadBtn.addEventListener('click', () => {
      const svg = barcodeSvg;
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(svg);
      const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'coop-barcode.svg';
      a.click();
      URL.revokeObjectURL(url);
    });

    [barcodeInput, priceInput, nameInput].forEach(i => i.addEventListener('keydown', e => {
      if (e.key === 'Enter') generateBtn.click();
    }));
  </script>
</body>
</html>
