<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>COOP Barcode Generator</title>
<style>
  :root{--bg:#111;--card:#1c1c1c;--accent:#2196f3}
  html,body{height:100%}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#fff;display:flex;align-items:center;justify-content:center;margin:0;padding:20px}
  .card{width:420px;background:var(--card);padding:20px;border-radius:10px;text-align:center;box-shadow:0 0 16px rgba(0,0,0,0.6)}
  h1{margin:0 0 12px;color:var(--accent);font-size:1.3rem}
  input{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:none;background:#222;color:#fff;font-size:15px;outline:none}
  input:focus{box-shadow:0 0 0 3px rgba(33,150,243,0.08)}
  .row{display:flex;gap:8px;justify-content:center;margin-top:12px}
  button{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:#071018;font-weight:700;cursor:pointer}
  button.alt{background:#444;color:#fff}
  button:active{transform:translateY(1px)}
  #result{margin-top:16px;display:none}
  canvas{display:block;margin:10px auto;border-radius:6px;background:#fff}
  .error{color:#f44336;margin-top:8px;font-weight:700}
  small{color:#aaa;display:block;margin-top:6px}
</style>
</head>
<body>
  <div class="card">
    <h1>COOP Barcode Generator</h1>

    <input id="barcodeIn" inputmode="numeric" placeholder="Barcode digits (e.g. 501234567890)" />
    <input id="priceIn" type="number" min="1" max="99" placeholder="Price (pence) — optional" />

    <div class="row">
      <button id="genBtn">Generate</button>
      <button id="dlBtn" class="alt">Download PNG</button>
    </div>

    <div id="result">
      <canvas id="outCanvas" width="360" height="160"></canvas>
    </div>

    <div id="error" class="error" role="alert"></div>
    <small>made by kv </small>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script>
    const barcodeIn = document.getElementById('barcodeIn');
    const priceIn = document.getElementById('priceIn');
    const genBtn = document.getElementById('genBtn');
    const dlBtn = document.getElementById('dlBtn');
    const outCanvas = document.getElementById('outCanvas');
    const resultDiv = document.getElementById('result');
    const err = document.getElementById('error');
    const ctx = outCanvas.getContext('2d');

    function calcCheckDigit(base12) {
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        const n = parseInt(base12[i], 10);
        if (Number.isNaN(n)) return null;
        sum += (i % 2 === 0) ? n : n * 3;
      }
      const mod = sum % 10;
      return mod === 0 ? 0 : 10 - mod;
    }

    function normalizeToEAN13(raw) {
      let cleaned = (raw || '').replace(/\D/g, '');
      if (!cleaned.length) return null;
      if (cleaned.length > 13) cleaned = cleaned.slice(-13);
      if (cleaned.length < 13) cleaned = cleaned.padStart(13, '0');
      const base12 = cleaned.slice(0, 12);
      const check = calcCheckDigit(base12);
      if (check === null) return null;
      return base12 + String(check);
    }

    async function renderToCanvas(ean13, pricePence) {
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', '340');
      svg.setAttribute('height', '100');

      try {
        JsBarcode(svg, ean13, {
          format: 'ean13',
          flat: true,          
          displayValue: false,
          height: 70,
          margin: 0,
          width: 2
        });
      } catch (e) {
        throw new Error('Barcode render failed: ' + e.message);
      }

      const svgStr = new XMLSerializer().serializeToString(svg);
      const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const img = new Image();
      img.src = url;

      await new Promise((res, rej) => {
        img.onload = () => res();
        img.onerror = (ev) => rej(new Error('SVG->Image conversion failed'));
      });
      const canvasW = 360;
      const priceArea = (typeof pricePence === 'number' && !Number.isNaN(pricePence)) ? 40 : 10;
      const canvasH = Math.max(100 + priceArea, 140);

      outCanvas.width = canvasW;
      outCanvas.height = canvasH;

      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, canvasW, canvasH);

      const targetBarcodeW = 320; 
      const scale = targetBarcodeW / img.width;
      const drawW = img.width * scale;
      const drawH = img.height * scale;
      const dx = (canvasW - drawW) / 2;
      const dy = 10; 
      ctx.drawImage(img, dx, dy, drawW, drawH);

      if (typeof pricePence === 'number' && !Number.isNaN(pricePence)) {
        const priceText = `£${(pricePence / 100).toFixed(2)}`;
        ctx.fillStyle = '#000';
        ctx.font = 'bold 28px Arial';
        const textW = ctx.measureText(priceText).width;
        const tx = (canvasW - textW) / 2;
        const ty = drawH + dy + 36;
        ctx.fillText(priceText, tx, ty);
      }

      URL.revokeObjectURL(url);
    }

    genBtn.addEventListener('click', async () => {
      err.textContent = '';
      resultDiv.style.display = 'none';

      const raw = barcodeIn.value.trim();
      const priceRaw = priceIn.value.trim();

      if (!raw) { err.textContent = 'Enter barcode digits'; return; }
      const ean13 = normalizeToEAN13(raw);
      if (!ean13) { err.textContent = 'Invalid barcode digits'; return; }
d
      let priceNum = null;
      if (priceRaw !== '') {
        const p = parseInt(priceRaw, 10);
        if (Number.isNaN(p) || p < 1 || p > 99) { err.textContent = 'Price must be 1–99 pence'; return; }
        priceNum = p;
      }

      try {
        await renderToCanvas(ean13, priceNum);
        resultDiv.style.display = 'block';
      } catch (e) {
        console.error(e);
        err.textContent = 'Render failed';
      }
    });

    dlBtn.addEventListener('click', () => {
      if (outCanvas.width === 0 || outCanvas.height === 0) { err.textContent = 'Generate first'; return; }
      outCanvas.toBlob((blob) => {
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = 'coop-barcode.png';
        a.click();
        URL.revokeObjectURL(url);
      }, 'image/png');
    });

    [barcodeIn, priceIn].forEach(el => {
      el.addEventListener('keydown', (e) => { if (e.key === 'Enter') genBtn.click(); });
    });
  </script>
</body>
</html>

